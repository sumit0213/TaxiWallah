<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Example</title>
    <style>
        #map {
            height: 400px;
            width: 50%;
            float: left;
        }

        #details {
            width: 50%;
            float: left;
            box-sizing: border-box;
            padding: 20px;
        }

        .selected {
            background-color: #4CAF50;
            color: white;
        }
        #loadingMessage {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    </style>
</head>
<body>
    <div>
        <label for="locationA">Location A:</label>
        <input type="text" id="locationA" placeholder="Enter location A" onfocus="geolocate()">
        <button onclick="useCurrentLocation()">Use Current Location</button>
        <div id="currentLocationOutput"></div>
    </div>
    <div>
        <label for="locationB">Location B:</label>
        <input type="text" id="locationB" placeholder="Enter location B" onfocus="geolocate()" onchange="calculateRoute()">
    </div>
    <button onclick="calculateRoute()">Calculate Route</button>
    <div>
        <strong>Distance:</strong> <span id="distance"></span><br>
        <strong>Time:</strong> <span id="duration"></span>
    </div>
    <div>
        <button onclick="setCAB('CAB A')" id="CAB_A">CAB A</button>
        <button onclick="setCAB('CAB B')" id="CAB_B">CAB B</button>
        <button onclick="setCAB('CAB C')" id="CAB_C">CAB C</button>
        <button onclick="setCAB('CAB D')" id="CAB_D">CAB D</button>
    </div>
    <div id="map"></div>
    <div id="details">
        <div>
            <strong>Market Price:</strong>
            <ul id="marketPriceList"></ul>
        </div>
        <div>
            <label for="expectedFair">Expected Fair:</label>
            <input type="number" id="expectedFair" placeholder="Enter expected fair (-50 to +100)">
            <button onclick="searchFair()">Search</button>
        </div>
        <div id="selectedDetails" style="display:none">
            <h2>Selected Details:</h2>
            <p id="selectedDetailsContent"></p>
        </div>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_OF-GCSb49quE1Jbs9vA7_cotXjQaPpk&libraries=places&callback=initMap" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Your JavaScript code goes here
       // Initialize Firebase

// Now you can use 'database' and 'ref' in your functions
function searchFair() {
    var expectedFairInput = document.getElementById('expectedFair');
    var expectedFair = parseFloat(expectedFairInput.value);

    // Check if selectedDetails is fully populated
    if (
        selectedDetails &&
        selectedDetails.cab &&
        selectedDetails.locationA &&
        selectedDetails.locationB &&
        selectedDetails.distance &&
        selectedDetails.duration
    ) {

        // Create an element for displaying the loading message
            var loadingMessage = document.createElement('div');
            loadingMessage.id = 'loadingMessage';
            loadingMessage.textContent = 'Searching for driver...';
            document.body.appendChild(loadingMessage);

            // Toggle the visibility of the loading message
            loadingMessage.style.display = 'block';

        // Geocode locationA and locationB to get their latLng
        geocodeLocation(selectedDetails.locationA, function (latLngA) {
            geocodeLocation(selectedDetails.locationB, function (latLngB) {
                // Store selected details in Firebase Realtime Database
                const ridesRef = firebase.database().ref('cabRides');
                const newRideRef = ridesRef.push({
                    cab: selectedDetails.cab,
                    marketPrice: calculateMarketPrice(cabRates[selectedDetails.cab], parseFloat(selectedDetails.distance)).toFixed(2) * 1000,
                    locationA: {
                        address: selectedDetails.locationA,
                        latLng: latLngA
                    },
                    locationB: {
                        address: selectedDetails.locationB,
                        latLng: latLngB
                    },
                    distance: selectedDetails.distance,
                    duration: selectedDetails.duration,
                    expectedFair: expectedFair
                });
                // Hide the loading message when the operation is complete
                loadingMessage.style.display = 'none';

                console.log('Ride added to the database:', newRideRef.key);
                // Delay hiding the loading message for 1 minute (60,000 milliseconds)
                setTimeout(function () {
                // Hide the loading message when the delay is complete
                loadingMessage.style.display = 'none';
            }, 60000);
            });
        });
    } else {
        // Provide feedback or perform additional actions if needed
        console.log('Error: selectedDetails is not fully populated');
    }
    
    // Geocode locationA and locationB to get their latLng
    // geocodeLocation(selectedDetails.locationA, function (latLngA) {
    //     geocodeLocation(selectedDetails.locationB, function (latLngB) {
    //         // ... existing code ...

    //         // Hide the loading message when the operation is complete
    //         loadingMessage.style.display = 'none';
    //     });
    // });
}

function geocodeLocation(address, callback) {
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': address }, function (results, status) {
        if (status === 'OK' && results[0]) {
            var location = results[0].geometry.location;
            var latLng = {
                lat: location.lat(),
                lng: location.lng()
            };
            callback(latLng);
        } else {
            console.log('Geocoding error for address:', address);
            callback(null);
        }
    });
}

var map;
    var currentLocationMarker;
    var cabRates = {
        'CAB A': 10,
        'CAB B': 20.22,
        'CAB C': 30,
        'CAB D': 5
    };
    var selectedCab = '';
    var selectedDetails = {};

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var initialLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                map = new google.maps.Map(document.getElementById('map'), {
                    center: initialLocation,
                    zoom: 12
                });

                // Set up autocomplete for location A and location B
                var autocompleteA = new google.maps.places.Autocomplete(document.getElementById('locationA'));
                autocompleteA.setFields(['geometry']);

                var autocompleteB = new google.maps.places.Autocomplete(document.getElementById('locationB'));
                autocompleteB.setFields(['geometry']);
            }, function () {
                // Handle errors when getting the current location
                handleLocationError(true, map.getCenter());
            });
        } else {
            // Browser doesn't support geolocation
            handleLocationError(false, map.getCenter());
        }
    }

    function handleLocationError(browserHasGeolocation, initialLocation) {
        // Handle errors when geolocation is not supported or failed
        map = new google.maps.Map(document.getElementById('map'), {
            center: initialLocation,
            zoom: 2
        });
    }

    function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Display coordinates
                    var outputDiv = document.getElementById('currentLocationOutput');
                    outputDiv.innerHTML = `<p>Coordinates: ${pos.lat}, ${pos.lng}</p>`;

                    // Fetch and display address using Geocoding
                    var geocoder = new google.maps.Geocoder();
                    var latLng = new google.maps.LatLng(pos.lat, pos.lng);

                    geocoder.geocode({ 'latLng': latLng }, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        // Display address
                        outputDiv.innerHTML += `<p>Address: ${results[1].formatted_address}</p>`;
                    } else {
                        console.log('No results found');
                    }
                } else {
                    console.log('Geocoder failed due to: ' + status);
                }
            });

            map.setCenter(pos);

                }, function () {
                    alert('Error: The Geolocation service failed.');
                });
            } else {
                alert('Error: Your browser doesn\'t support geolocation.');
            }
        }
        function useCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // Display coordinates
            var outputDiv = document.getElementById('currentLocationOutput');
            outputDiv.innerHTML = `<p>Coordinates: ${pos.lat}, ${pos.lng}</p>`;

            // Fetch and display address using Geocoding
            var geocoder = new google.maps.Geocoder();
            var latLng = new google.maps.LatLng(pos.lat, pos.lng);

            geocoder.geocode({ 'latLng': latLng }, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        // Display address
                        var address = results[1].formatted_address;
                        outputDiv.innerHTML += `<p>Address: ${address}</p>`;

                        // Set the address in the "Location A" input field
                        document.getElementById('locationA').value = address;
                    } else {
                        console.log('No results found');
                    }
                } else {
                    console.log('Geocoder failed due to: ' + status);
                }
            });

            // Set the center of the map to the current position
            map.setCenter(pos);

            // Other existing logic...
        }, function () {
            alert('Error: The Geolocation service failed.');
        });
    } else {
        alert('Error: Your browser doesn\'t support geolocation.');
    }
}

    // Other functions remain unchanged...

    // Firebase initialization
    var firebaseConfig = {
        apiKey: "AIzaSyD_OF-GCSb49quE1Jbs9vA7_cotXjQaPpk",
        authDomain: "urban-cab-2-96e07.firebaseapp.com",
        databaseURL: "https://urban-cab-2-96e07-default-rtdb.firebaseio.com",
        projectId: "urban-cab-2-96e07",
        storageBucket: "urban-cab-2-96e07.appspot.com",
        messagingSenderId: "655633876241",
        appId: "1:655633876241:web:e0db94634c06e34dcef8b0",
        measurementId: "G-CW48Z88FY3"
    };
    if (firebase.apps.length === 0) {
    firebase.initializeApp(firebaseConfig);
    }

    // Now you can use 'firebase.database()' and 'ref' in your functions
    // function searchFair() {
        
    // }

function calculateRoute() {
    var locationA = document.getElementById('locationA').value;
    var locationB = document.getElementById('locationB').value;

    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: locationA }, function (results, status) {
        if (status === 'OK' && results[0]) {
            var coordsA = results[0].geometry.location;

            geocoder.geocode({ address: locationB }, function (results, status) {
                if (status === 'OK' && results[0]) {
                    var coordsB = results[0].geometry.location;

                    var directionsService = new google.maps.DirectionsService();
                    var request = {
                        origin: coordsA,
                        destination: coordsB,
                        travelMode: 'DRIVING'
                    };

                    var directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
                    directionsService.route(request, function (result, status) {
                        if (status == 'OK') {
                            directionsRenderer.setDirections(result);

                            // Display distance and duration
                            var route = result.routes[0];
                            var distance = route.legs[0].distance.text;
                            var duration = route.legs[0].duration.text;

                            document.getElementById('distance').textContent = distance;
                            document.getElementById('duration').textContent = duration;

                            // Display market prices for all cabs
                            displayMarketPrices(route.legs[0].distance.value);

                            // Store selected details
                            selectedDetails = {
                                cab: selectedCab,
                                locationA: locationA,
                                locationB: locationB,
                                distance: distance,
                                duration: duration
                            };

                            // Set selected details content
                            setSelectedDetailsContent();
                        } else {
                            alert('Error: Unable to retrieve directions.');
                        }
                    });
                } else {
                    alert('Error: Unable to geocode location B.');
                }
            });
        } else {
            alert('Error: Unable to geocode location A.');
        }
    });
}

function calculateMarketPrice(selectedCabRate, distanceInMeters) {
    // Convert distance from meters to kilometers
    var distanceInKm = distanceInMeters / 1000;

    // Calculate market price
    var marketPrice = selectedCabRate * distanceInKm;

    return marketPrice;
}

function displayMarketPrices(distanceInMeters) {
    // Convert distance from meters to kilometers
    var distanceInKm = distanceInMeters / 1000;

    // Display market prices for all cabs
    var marketPriceList = document.getElementById('marketPriceList');
    marketPriceList.innerHTML = ''; // Clear previous entries

    for (var cab in cabRates) {
        var marketPrice = calculateMarketPrice(cabRates[cab], distanceInMeters);
        var listItem = document.createElement('li');
        listItem.textContent = cab + ': Rs ' + marketPrice.toFixed(2) + ' (Rs ' + cabRates[cab] + ' per km)';
        marketPriceList.appendChild(listItem);
    }
}

function setCAB(cab) {
    // Reset market price display
    document.getElementById('marketPriceList').innerHTML = '';

    // Set selected cab and highlight the button
    selectedCab = cab;
    resetCabButtons();

    var selectedCabButton = document.getElementById('CAB_' + cab.replace(' ', '_'));
    if (selectedCabButton) {
        selectedCabButton.classList.add('selected');
    }

    // Store selected details
    selectedDetails = {
        cab: selectedCab,
        locationA: document.getElementById('locationA').value,
        locationB: document.getElementById('locationB').value,
        distance: document.getElementById('distance').textContent,
        duration: document.getElementById('duration').textContent
    };

    // Display selected details
    setSelectedDetailsContent();

    // Show expected fair input
    document.getElementById('expectedFair').style.display = 'block';
}

function setSelectedDetailsContent() {
    // Display selected details
    var selectedDetailsContent = document.getElementById('selectedDetailsContent');
    selectedDetailsContent.innerHTML = `
        <p><strong>Cab:</strong> ${selectedDetails.cab}</p>
        <p><strong>Market Price:</strong> Rs ${calculateMarketPrice(cabRates[selectedDetails.cab], parseFloat(selectedDetails.distance)).toFixed(2) * 1000}</p>
        <p><strong>Location A:</strong> ${selectedDetails.locationA}</p>
        <p><strong>Location B:</strong> ${selectedDetails.locationB}</p>
        <p><strong>Distance:</strong> ${selectedDetails.distance}</p>
        <p><strong>Duration:</strong> ${selectedDetails.duration}</p>
    `;
    document.getElementById('selectedDetails').style.display = 'block';
}

function resetCabButtons() {
    // Remove the 'selected' class from all cab buttons
    var cabButtons = document.querySelectorAll('button[id^="CAB_"]');
    cabButtons.forEach(function(button) {
        button.classList.remove('selected');
    });
}


function geolocate() {
    // Implement geolocation logic here
    // if (navigator.geolocation) {
    //     navigator.geolocation.getCurrentPosition(function (position) {
    //         var pos = {
    //             lat: position.coords.latitude,
    //             lng: position.coords.longitude
    //         };

    //        // Set the retrieved coordinates in the locationA input field
    //          document.getElementById('locationA').value = pos.lat + ', ' + pos.lng;
    //     }, function () {
    //         alert('Error: The Geolocation service failed.');
    //     });
    // } else {
    //     alert('Error: Your browser doesn\'t support geolocation.');
    // }
}

    </script>
</body>
</html>